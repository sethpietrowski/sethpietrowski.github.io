import{r as E,j as d,B as $e}from"./index-CDocZZU0.js";function ce(e,t,s,r){return(1-e)**2*t+2*(1-e)*e*s+e**2*r}function Y(e,t,s,r,l){e=Math.max(0,Math.min(e,s.exit_x));const u=e/s.exit_x,a=s,c=ce(u,ce(u,a.inlet_radius,a.cp1y,a.throat_radius),ce(u,a.throat_radius,a.cp2y,a.switcher_y),ce(u,a.switcher_y,a.cp3y,a.exit_radius))*r;return t?l/2-c:l/2+c}function qe(e,t,s,r,l){const u=Array(e).fill(0),a=Array(e).fill(0);for(let i=0;i<e;i++){const c=i*t+t/2,m=t;if(i<e-1){const p=Y(c,!0,s,r,l),g=Y(c,!1,s,r,l),v=Y(c+m,!0,s,r,l),y=Y(c+m,!1,s,r,l);u[i]=Math.atan2(v-p,m),a[i]=Math.atan2(y-g,m)}else u[i]=u[i-1]||0,a[i]=a[i-1]||0}return{top:u,bottom:a}}function Ge(e,t,s,r){if(e<=0)return t.inlet_radius*s;if(e>=t.exit_x)return t.exit_radius*s;const l=Y(e,!0,t,s,r),u=Y(e,!1,t,s,r);return Math.abs(u-l)/2}function Oe(e){const{rows:t,cols:s,cellWidth:r,cellHeight:l,controlPoints:u,scaleY:a,canvasHeight:i}=e;console.log("Creating flow domain with dimensions:",s,"x",t),e.isInside=Array.from({length:t},()=>Array(s).fill(!1)),e.isBoundary=Array.from({length:t},()=>Array(s).fill(!1));const c=qe(s,r,u,a,i);e.wallAngleTop=c.top,e.wallAngleBottom=c.bottom;for(let g=0;g<t;g++)for(let v=0;v<s;v++){const y=v*r+r/2,S=g*l+l/2;if(y<=u.exit_x){const f=Y(y,!0,u,a,i),h=Y(y,!1,u,a,i);if(S>=f&&S<=h){e.isInside[g][v]=!0;const w=Math.abs(S-f),A=Math.abs(S-h),I=Math.min(w,A),b=Math.max(r,l)*1.5;I<b&&(e.isBoundary[g][v]=!0)}}}let m=0,p=0;for(let g=0;g<t;g++)for(let v=0;v<s;v++)e.isInside[g][v]&&(e.isBoundary[g][v]?p++:m++);console.log(`Domain created: ${m} interior cells, ${p} boundary cells`)}function Me(e){const{rows:t,cols:s,isInside:r,isBoundary:l}=e,u=3e5,a=100,i=300,c=287;console.log("Initializing flow field...");for(let m=0;m<t;m++)for(let p=0;p<s;p++)if(r[m][p]){const g=p/(s-1);e.velocityX[m][p]=a*(1+g*1),e.velocityY[m][p]=0,e.pressure[m][p]=u*(1-g*.5),e.temperature[m][p]=i*(1-g*.15),e.density[m][p]=e.pressure[m][p]/(c*e.temperature[m][p]),l[m][p]&&(e.velocityX[m][p]=0,e.velocityY[m][p]=0)}console.log("Flow field initialized.")}let de=[],me=[],ge=[];function Qe(e,t){de.length===0&&(de=Array.from({length:e},()=>Array(t).fill(0)),me=Array.from({length:e},()=>Array(t).fill(0)),ge=Array.from({length:e},()=>Array(t).fill(0)))}function Ke(e){const{rows:t,cols:s,velocityX:r,velocityY:l,pressure:u}=e;Qe(t,s);for(let a=0;a<t;a++)for(let i=0;i<s;i++)de[a][i]=r[a][i],me[a][i]=l[a][i],ge[a][i]=u[a][i]}function Je(e,t,s,r,l){const{velocityX:u,velocityY:a,cellWidth:i,cellHeight:c,rows:m,cols:p}=l;let g=0,v=0;if(s>.3){if(t>0&&t<p-1){const y=u[e][t+1]-u[e][t-1];g=-.1*r*Math.abs(y)*y/(2*i)}if(e>0&&e<m-1){const y=a[e+1][t]-a[e-1][t];v=-.1*r*Math.abs(y)*y/(2*i)}}return{x:g,y:v}}function Ce(e){const{rows:t,cols:s,isInside:r,isBoundary:l,velocityX:u,velocityY:a,pressure:i,density:c,cellWidth:m,cellHeight:p}=e;let g=0,v=0,y=0,S=0;for(let f=1;f<t-1;f++)for(let h=1;h<s-1;h++)if(r[f][h]&&!l[f][h]){const w=u[f][h]-de[f][h],A=a[f][h]-me[f][h];g+=w*w+A*A;const I=i[f][h]-ge[f][h];v+=I*I;const b=c[f][h],C=c[f][h-1]||b,R=c[f][h+1]||b,D=c[f-1][h]||b,U=c[f+1][h]||b,B=u[f][h-1]||u[f][h],M=u[f][h+1]||u[f][h],z=a[f-1][h]||a[f][h],N=a[f+1][h]||a[f][h],T=(R*M-C*B)/(2*m),_=(U*N-D*z)/(2*p),P=Math.abs(T+_);y+=P*P,S++}return{velocity:Math.sqrt(g/Math.max(S,1)),pressure:Math.sqrt(v/Math.max(S,1)),mass:Math.sqrt(y/Math.max(S,1))}}function Ze(e){const t=L;t.velocity.push(e.velocity),t.pressure.push(e.pressure),t.mass.push(e.mass),t.velocity.length>t.maxHistory&&(t.velocity.shift(),t.pressure.shift(),t.mass.shift())}function et(e){const t=e.velocity<G.velocity,s=e.pressure<G.pressure,r=e.mass<G.mass;return t&&s&&r}function tt(e){if(j.state!=="running"||!e)return!1;Ke(e);const t=1.4,s=287,r=3e5,l=100,u=300,a=3.5,i=.15,c=.05,{rows:m,cols:p,cellWidth:g,cellHeight:v,isInside:y,isBoundary:S,velocityX:f,velocityY:h,pressure:w,density:A,temperature:I,controlPoints:b,scaleY:C,canvasHeight:R,wallAngleTop:D,wallAngleBottom:U}=e;let B=0;for(let n=0;n<m;n++)for(let o=0;o<p;o++)if(y[n][o]){const K=Math.sqrt(f[n][o]**2+h[n][o]**2);B=Math.max(B,K)}const z=Math.min(1e-4,.5*Math.min(g,v)/Math.max(B,1)),N=f.map(n=>[...n]),T=h.map(n=>[...n]),_=w.map(n=>[...n]),P=A.map(n=>[...n]),Q=I.map(n=>[...n]);for(let n=0;n<m;n++)for(let o=0;o<4;o++)y[n][o]&&!S[n][o]&&(N[n][o]=l,T[n][o]=0,_[n][o]=r,P[n][o]=a,Q[n][o]=u);for(let n=2;n<m-2;n++)for(let o=3;o<p-3;o++){if(!y[n][o]||S[n][o])continue;const K=o*g+g/2,te=n*v+v/2,O=A[n][o],X=f[n][o],H=h[n][o],se=w[n][o],ae=Math.sqrt(t*se/O),J=Math.sqrt(X*X+H*H)/ae;let V,$,q,F,k,ne;J<.8?(V=(w[n][o+1]-w[n][o-1])/(2*g),$=(w[n+1][o]-w[n-1][o])/(2*v),q=(f[n][o+1]-f[n][o-1])/(2*g),F=(f[n+1][o]-f[n-1][o])/(2*v),k=(h[n][o+1]-h[n][o-1])/(2*g),ne=(h[n+1][o]-h[n-1][o])/(2*v)):(X>0?(V=(w[n][o]-w[n][o-1])/g,q=(f[n][o]-f[n][o-1])/g,k=(h[n][o]-h[n][o-1])/g):(V=(w[n][o+1]-w[n][o])/g,q=(f[n][o+1]-f[n][o])/g,k=(h[n][o+1]-h[n][o])/g),H>0?($=(w[n][o]-w[n-1][o])/v,F=(f[n][o]-f[n-1][o])/v,ne=(h[n][o]-h[n-1][o])/v):($=(w[n+1][o]-w[n][o])/v,F=(f[n+1][o]-f[n][o])/v,ne=(h[n+1][o]-h[n][o])/v));const ie=Je(n,o,J,O,e),oe=R/2,be=Ge(K,b,C,R),ke=b.throat_radius*C,ze=te<oe?D?D[o]:0:U?U[o]:0;let re=0;if(be>ke*1.1){const He=Math.abs(te-oe)/be;re=Math.sin(ze)*X*He*.05,te>oe&&(re=-re)}const _e=X*k+H*F,Ne=X*q+H*ne,Be=-V/Math.max(O,.5)-_e*.2+ie.x,Pe=-$/Math.max(O,.5)-Ne*.2+re+ie.y,le=.5*ae/z,Ve=Math.max(-le,Math.min(le,Be)),Le=Math.max(-le,Math.min(le,Pe));N[n][o]=X+Ve*z,T[n][o]=H+Le*z;const We=800,we=200;N[n][o]=Math.max(.01,Math.min(We,N[n][o])),T[n][o]=Math.max(-we,Math.min(we,T[n][o]));const Ye=N[n][o]**2+T[n][o]**2,De=X**2+H**2,Ue=t/(t-1)*se/O+.5*De-.5*Ye;Q[n][o]=Math.max(.1,Ue*(t-1)/t),_[n][o]=Math.max(.05,O*s*Q[n][o]);const Xe=Math.min(5,Math.max(.01,_[n][o]/r));P[n][o]=Math.max(.5,a*Math.pow(Xe,1/t)),Q[n][o]=Math.min(500,Math.max(200,Q[n][o])),_[n][o]=Math.min(5e5,Math.max(5e4,_[n][o])),P[n][o]=Math.min(5,Math.max(.5,P[n][o]))}for(let n=0;n<m;n++)for(let o=0;o<p;o++){if(!S[n][o])continue;const K=n*v+v/2,te=o*g+g/2;let O=l,X=0,H=r,se=a,ae=u,J=!1;for(let V=2;V<=6&&!J;V++)for(let $=-V;$<=V&&!J;$++)for(let q=-V;q<=V&&!J;q++){const F=n+$,k=o+q;F>=0&&F<m&&k>=0&&k<p&&y[F][k]&&!S[F][k]&&(O=f[F][k],X=h[F][k],H=w[F][k],se=A[F][k],ae=I[F][k],J=!0)}if(J){const V=Y(te,!0,b,C,R),$=Y(te,!1,b,C,R),q=Math.abs(K-V),F=Math.abs(K-$),k=Math.min(q,F),ne=Math.max(g,v)*1.5,ie=Math.min(1,k/ne),oe=Math.pow(ie,.3);N[n][o]=O*oe,T[n][o]=X*oe*.7,_[n][o]=H,P[n][o]=se,Q[n][o]=ae}}for(let n=0;n<m;n++)for(let o=p-4;o<p;o++)if(y[n][o]&&!S[n][o]){const K=o>0?(f[n][o]-f[n][o-1])/g:0;N[n][o]=Math.max(f[n][o],f[n][o]+K*g),T[n][o]=h[n][o],_[n][o]=Math.max(5e4,w[n][o]*.98),P[n][o]=A[n][o]*.99,Q[n][o]=I[n][o]}for(let n=0;n<m;n++)for(let o=0;o<p;o++)y[n][o]&&(f[n][o]=i*N[n][o]+(1-i)*f[n][o],h[n][o]=i*T[n][o]+(1-i)*h[n][o],w[n][o]=c*_[n][o]+(1-c)*w[n][o],A[n][o]=c*P[n][o]+(1-c)*A[n][o],I[n][o]=c*Q[n][o]+(1-c)*I[n][o]);const xe=Ce(e);return Ze(xe),et(xe)?(updateSimulationStatus("converged"),!1):(j.totalIterations++,j.totalIterations>1e4?(console.log("Maximum iterations reached"),!1):!0)}function nt(e){return Ce(e)}function ot(e,t,s){const r=e.getContext("2d");return e.width=1e3,e.height=500,r.clearRect(0,0,e.width,e.height),t&&(t.width=30,t.height=400),s&&(s.width=380,s.height=250),r}function Se(e,t){const{controlPoints:s,scaleY:r,canvasHeight:l}=t;if(!s)return;e.strokeStyle="#333",e.lineWidth=2,e.fillStyle="rgba(100,100,100,0.3)";const u=200;e.beginPath();for(let a=0;a<=u;a++){const i=a/u*s.exit_x,c=Y(i,!0,s,r,l);a===0?e.moveTo(i,c):e.lineTo(i,c)}for(let a=u;a>=0;a--){const i=a/u*s.exit_x,c=Y(i,!1,s,r,l);e.lineTo(i,c)}e.closePath(),e.fill(),e.stroke(),e.strokeStyle="rgba(0,0,0,0.4)",e.lineWidth=2,e.setLineDash([10,5]),e.beginPath(),e.moveTo(0,l/2),e.lineTo(s.exit_x,l/2),e.stroke(),e.setLineDash([])}function Ee(e,t,s=null){const{rows:r,cols:l,velocityX:u,velocityY:a,pressure:i,temperature:c,density:m,isInside:p,isBoundary:g,cellWidth:v,cellHeight:y,visualizationMode:S}=t;let f;switch(S){case"pressure":f=i;break;case"temperature":f=c;break;case"density":f=m;break;case"velocity":f=Array.from({length:r},(b,C)=>Array.from({length:l},(R,D)=>{if(!u[C])return 0;const U=u[C][D]||0,B=a[C][D]||0;return Math.sqrt(U*U+B*B)}));break;default:f=i}const h=[];for(let b=0;b<r;b++)for(let C=0;C<l;C++)if(p[b][C]&&!g[b][C]){const R=f[b]?.[C];R!==void 0&&!isNaN(R)&&isFinite(R)&&h.push(R)}if(h.length===0){console.warn("No valid data for visualization");return}const w=Math.min(...h),A=Math.max(...h),I=h.reduce((b,C)=>b+C,0)/h.length;s?.onStatsUpdate&&s.onStatsUpdate({min:w,max:A,avg:I}),e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";for(let b=0;b<r;b++)for(let C=0;C<l;C++){if(!p[b][C])continue;const R=f[b]?.[C];if(R===void 0||!isFinite(R))continue;const D=je(R,w,A,S);e.fillStyle=D,e.fillRect(C*v,b*y,v+.5,y+.5)}st(w,A,S)}function je(e,t,s,r){isFinite(e)||(e=t);let l=0;s>t&&(l=Math.max(0,Math.min(1,(e-t)/(s-t))));let u,a,i;switch(r){case"velocity":if(l<.25){const c=l/.25;u=0,a=Math.floor(c*255),i=255}else if(l<.5){const c=(l-.25)/.25;u=0,a=255,i=Math.floor(255*(1-c))}else if(l<.75){const c=(l-.5)/.25;u=Math.floor(c*255),a=255,i=0}else{const c=(l-.75)/.25;u=255,a=Math.floor(255*(1-c)),i=0}break;case"pressure":case"temperature":case"density":u=Math.floor(l*255),a=0,i=Math.floor((1-l)*255);break;default:u=Math.floor(l*255),a=Math.floor(l*128),i=Math.floor((1-l)*255)}return`rgb(${u}, ${a}, ${i})`}function st(e,t,s){const r=document.getElementById("colorbar");if(!r)return;const l=r.getContext("2d"),u=r.height,a=r.width;l.clearRect(0,0,a,u);const i=l.createLinearGradient(0,u,0,0),c=20;for(let y=0;y<=c;y++){const S=y/c,f=e+S*(t-e),h=je(f,e,t,s);i.addColorStop(S,h)}l.fillStyle=i,l.fillRect(0,0,a,u),l.strokeStyle="#ccc",l.lineWidth=1,l.strokeRect(0,0,a,u);const m=document.getElementById("max-label"),p=document.getElementById("min-label"),g=document.getElementById("colorbar-title");m&&(m.textContent=t.toFixed(3)),p&&(p.textContent=e.toFixed(3));const v={velocity:"Velocity (m/s)",pressure:"Pressure (Pa)",temperature:"Temperature (K)",density:"Density (kg/mÂ³)"};g&&(g.textContent=v[s]||"Value")}function Ie(e){if(!e){console.warn("Convergence canvas not found");return}const t=e.getContext("2d");if(!t){console.warn("Could not get convergence canvas context");return}const s=e.width,r=e.height;t.clearRect(0,0,s,r),t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(0,0,s,r),(!L||L.velocity.length<2)&&(t.fillStyle="rgba(255,255,255,0.8)",t.font="16px Arial",t.textAlign="center",t.fillText("No convergence data yet",s/2,r/2));const l=[...L.velocity.filter(p=>isFinite(p)&&p>0),...L.pressure.filter(p=>isFinite(p)&&p>0),...L.mass.filter(p=>isFinite(p)&&p>0)];if(l.length===0){t.fillStyle="rgba(255,255,255,0.8)",t.font="16px Arial",t.textAlign="center",t.fillText("Invalid convergence data",s/2,r/2);return}const u=Math.max(1e-12,Math.min(...l)),a=Math.max(u*10,Math.max(...l)),i=Math.log10(u),c=Math.log10(a),m=c-i;if(m<=0){t.fillStyle="rgba(255,255,255,0.8)",t.font="16px Arial",t.textAlign="center",t.fillText("Insufficient data range",s/2,r/2);return}at(t,s,r,i,c,m),it(t,s,r,i,m),rt(t,s,r,i,m),lt(t,s)}function at(e,t,s,r,l,u){e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1,e.font="10px Arial",e.fillStyle="rgba(255,255,255,0.7)";for(let i=Math.floor(r);i<=Math.ceil(l);i++){const c=s-(i-r)/u*s;e.beginPath(),e.moveTo(0,c),e.lineTo(t,c),e.stroke(),e.textAlign="left",e.fillText(`1e${i}`,5,c-2)}const a=L.velocity.length;if(a>1){const i=Math.max(1,Math.floor(a/5));for(let c=0;c<a;c+=i){const m=c/(a-1)*t;e.beginPath(),e.moveTo(m,0),e.lineTo(m,s),e.stroke(),c%(i*2)===0&&(e.textAlign="center",e.fillText(c.toString(),m,s-5))}}}function it(e,t,s,r,l){[{data:L.velocity,color:"blue",label:"Velocity"},{data:L.pressure,color:"green",label:"Pressure"},{data:L.mass,color:"red",label:"Mass"}].forEach(a=>{if(a.data.length<2)return;e.strokeStyle=a.color,e.lineWidth=2,e.beginPath();let i=!1;for(let c=0;c<a.data.length;c++){const m=a.data[c];if(!isFinite(m)||m<=0)continue;const p=a.data.length>1?c/(a.data.length-1)*t:t/2,g=Math.log10(Math.max(1e-12,m)),v=s-(g-r)/l*s;i?e.lineTo(p,v):(e.moveTo(p,v),i=!0)}i&&e.stroke()})}function rt(e,t,s,r,l){e.strokeStyle="rgba(255,255,255,0.7)",e.lineWidth=1,e.setLineDash([5,5]),[{value:G.velocity,color:"blue"},{value:G.pressure,color:"green"},{value:G.mass,color:"red"}].forEach(a=>{if(a.value<=0)return;const i=Math.log10(a.value);if(i<r||i>r+l)return;const c=s-(i-r)/l*s;e.strokeStyle=a.color,e.beginPath(),e.moveTo(0,c),e.lineTo(t,c),e.stroke()}),e.setLineDash([])}function lt(e,t,s){const r=[{color:"blue",label:"Velocity"},{color:"green",label:"Pressure"},{color:"red",label:"Mass"}];e.font="12px Arial",e.textAlign="left",r.forEach((l,u)=>{const a=t-80,i=20+u*20;e.fillStyle=l.color,e.fillRect(a,i-8,12,12),e.fillStyle="white",e.fillText(l.label,a+16,i+2)})}function ee(e){j.state=e;const t=document.getElementById("simulation-status"),s=document.getElementById("status-indicator"),r=document.getElementById("start-btn"),l=document.getElementById("pause-btn");if(!t||!s||!r||!l){console.log("Status updated to: ",e,"(DOM elements not found)");return}const a={running:{text:"Running",class:"status-indicator status-running",startDisabled:!0,pauseDisabled:!1},paused:{text:"Paused",class:"status-indicator status-paused",startDisabled:!1,pauseDisabled:!0},converged:{text:"Converged",class:"status-indicator status-converged",startDisabled:!1,pauseDisabled:!0},stopped:{text:"Ready",class:"status-indicator status-paused",startDisabled:!1,pauseDisabled:!0},ready:{text:"Ready",class:"status-indicator status-paused",startDisabled:!1,pauseDisabled:!0},error:{text:"Error",class:"status-indicator status-error",startDisabled:!0,pauseDisabled:!0}}[e.toLowerCase()];if(!a){console.warm("Unknown status:",e);return}t.textContent=a.text,s.className=a.class,r.disabled=a.startDisabled,l.disabled=a.pauseDisabled,console.log("Status updated to:",a.text)}function ct(e){const t=document.getElementById("time-step"),s=document.getElementById("total-iterations"),r=document.getElementById("velocity-residual"),l=document.getElementById("pressure-residual"),u=document.getElementById("mass-residual");t&&(t.textContent=j.timeStep),s&&(s.textContent=j.totalIterations),r&&(r.textContent=e.velocity.toExponential(3)),l&&(l.textContent=e.pressure.toExponential(3)),u&&(u.textContent=e.mass.toExponential(3));const a=Fe();a?.onConvergenceUpdate&&a.onConvergenceUpdate({timeStep:j.timeStep,totalIterations:j.totalIterations,velocityResidual:e.velocity.toExponential(3),pressureResidual:e.pressure.toExponential(3),massResidual:e.mass.toExponential(3)});const i=document.getElementById("convergence-canvas");if(i)try{Ie(i)}catch(c){console.error("Error drawing convergence chart:",c)}}function fe(){const e=document.getElementById("vel-tolerance"),t=document.getElementById("press-tolerance"),s=document.getElementById("mass-tolerance");if(e){const r=parseFloat(e.value)||1e-6;he("velocity",r)}if(t){const r=parseFloat(t.value)||1e-6;he("pressure",r)}if(s){const r=parseFloat(s.value)||1e-6;he("mass",r)}}function ut(){["vel-tolerance","press-tolerance","mass-tolerance"].forEach(t=>{const s=document.getElementById(t);s&&(s.addEventListener("change",fe),s.addEventListener("input",fe))})}function dt(e,t,s){console.log("Stating animation loop...");const r=()=>{if(j.state!=="running"){console.log("Animation loop stopped - simulation not running");return}if(!t){console.error("Simulation data not available for animation");return}const u=e.getContext("2d");if(!u){console.error("Failed to get canvas context");return}if(u.clearRect(0,0,e.width,e.height),j.timeStep%1===0){fe();let i;try{i=tt(t)}catch(c){console.error("Error updating flow: ",c),j.state="error",ee("error");return}if(j.timeStep%5===0)try{const c=nt(t);ct(c)}catch(c){console.error("Error updating convergence display: ",c)}if(!i){const c=Ae();c!==null&&(cancelAnimationFrame(c),ue(null)),j.state="converged",ee("converged"),ht(u,t,s);return}}j.timeStep++;try{ve(u,t,s)}catch(i){console.error("Error rendering frame: ",i)}const a=requestAnimationFrame(r);ue(a)},l=requestAnimationFrame(r);ue(l)}function pe(){const e=Ae();e!==null&&(cancelAnimationFrame(e),ue(null),console.log("Animation loop stopped"))}function ve(e,t,s){Ee(e,t,s),Se(e,t)}function ht(e,t,s){console.log("Rendering final convergeed state"),ve(e,t,s)}let Z=null;function ft(e){const t=document.getElementById("start-btn"),s=document.getElementById("pause-btn"),r=document.getElementById("reset-btn");Z={start:()=>{console.log("Start button clicked"),e?.start&&e.start()},pause:()=>{console.log("Pause button clicked"),e?.pause&&e.pause()},reset:()=>{console.log("Reset button clicked"),e?.reset&&e.reset()}},t&&(t.removeEventListener("click",Z.start),t.addEventListener("click",Z.start)),s&&(s.removeEventListener("click",Z.pause),s.addEventListener("click",Z.pause)),r&&(r.removeEventListener("click",Z.reset),r.addEventListener("click",Z.reset)),console.log("Control buttons setup complete")}function mt(){document.querySelectorAll('input[name="vizMode"]').forEach(t=>{t.addEventListener("change",s=>{const r=It();if(r){r.visualizationMode=s.target.value;const l=document.getElementById("fea-canvas");if(l){const u=l.getContext("2d");u.clearRect(0,0,l.width,l.height),ve(u,r,Fe())}console.log("Visualization mode changed to: ",s.target.value)}})})}function gt(e){console.log("Initializing UI controls...");try{mt(),ut(),ft(e),console.log("UI initialization complete")}catch(t){console.error("Error initializing UI: ",t)}}const j={state:"stopped",timeStep:0,totalIterations:0};let Re=null;function ue(e){Re=e}function Ae(){return Re}const L={velocity:[],pressure:[],mass:[],maxHistory:200};let G={velocity:1e-6,pressure:1e-6,mass:1e-6},x=null,W=null;function pt(e,t){if(console.log("=== FEA initialization starting ==="),!e)return console.error("Canvas is null or undefined"),null;const s=e.getContext("2d");return s?(x=t.current,console.log("Canvas Dimensions: ",e.width,"x",e.height),console.log("Simulation Data: ",x),setTimeout(()=>{try{vt(e,s),console.log("=== FEA initialization complete ===")}catch(r){console.error("Failed to initialize FEA: ",r),ee("error")}},100),xt(e)):(console.error("Could not get canvas context"),null)}function vt(e,t){t.clearRect(0,0,e.width,e.height),yt(e),console.log("Creating flow domain..."),Oe(x),console.log("Flow domain created. isInside length: ",x.isInside?.length),Te(),Me(x),ye(t),ee("ready")}function yt(e){x.canvasWidth=e.width,x.canvasHeight=e.height;const t=x.controlPoints.exit_x,s=e.width*.9/t;Object.keys(x.controlPoints).forEach(l=>{l.includes("_x")&&(x.controlPoints[l]*=s)});const r=Math.max(x.controlPoints.inlet_radius,x.controlPoints.exit_radius,x.controlPoints.throat_radius);x.scaleY=e.height*.35/r,x.cellWidth=x.canvasWidth/x.cols,x.cellHeight=x.canvasHeight/x.rows}function Te(){const{rows:e,cols:t}=x;x.velocityX=[],x.velocityY=[],x.pressure=[],x.temperature=[],x.density=[];for(let s=0;s<e;s++)x.velocityX[s]=new Array(t).fill(0),x.velocityY[s]=new Array(t).fill(0),x.pressure[s]=new Array(t).fill(101325),x.temperature[s]=new Array(t).fill(300),x.density[s]=new Array(t).fill(1.225)}function ye(e){try{Se(e,x),Ee(e,x,W),console.log("Initial rendering complete")}catch(t){console.error("Error rendering initial state: ",t)}}function xt(e){return{start:()=>bt(e),pause:()=>wt(),reset:()=>Mt(e),setTolerance:(t,s)=>Ct(t,s),setCallbacks:t=>St(t),updateVisualization:()=>Et(e),cleanup:()=>jt()}}function bt(e){console.log("Starting simulation..."),j.state="running",ee("running"),W?.onStatusUpdate&&W.onStatusUpdate("running"),dt(e,x,W)}function wt(){console.log("Pausing simulation..."),j.state="paused",ee("paused"),W?.onStatusUpdate&&W.onStatusUpdate("paused"),pe()}function Mt(e){console.log("Resetting simulation..."),pe(),j.state="stopped",j.timeStep=0,j.totalIterations=0,L.velocity=[],L.pressure=[],L.mass=[],Te();try{Me(x)}catch(s){console.log("Error reinitializing flow: ",s)}ee("ready"),W?.onStatusUpdate&&W.onStatusUpdate("ready"),W?.onConvergenceUpdate&&W.onConvergenceUpdate({timeStep:0,totalIterations:0,velocityResidual:"-",pressureResidual:"-",massResidual:"-"});const t=e.getContext("2d");ye(t)}function Ct(e,t){console.log(`Setting ${e} tolerance to ${t}`),e in G&&(G[e]=t)}function St(e){W=e,console.log("Callbacks set: ",Object.keys(W||{}))}function Et(e){const t=e.getContext("2d");ye(t)}function jt(){console.log("Cleaning up simulation..."),j.state="stopped",pe()}function It(){return x}function Fe(){return W}function he(e,t){e in G&&(G[e]=t)}function kt(){const e=E.useRef(null),t=E.useRef(null),s=E.useRef(null),[r,l]=E.useState("Initializing"),[u,a]=E.useState(!1),[i,c]=E.useState("velocity"),[m,p]=E.useState({min:0,avg:0,max:0}),[g,v]=E.useState({timeStep:0,totalIterations:0,velocityResidual:"-",pressureResidual:"-",massResidual:"-"});E.useRef(null);const y=E.useRef(null),[S,f]=E.useState(!1),[h,w]=E.useState({width:800,height:400}),A=M=>{switch(M.toLowerCase()){case"running":return"running";case"paused":return"paused";case"ready":return"ready";case"error":return"error";default:return"unknown"}},I=E.useRef({controlPoints:{inlet_radius:20,inlet_length:50,cp1x:60,cp1y:25,cp2x:100,cp2y:40,cp3x:150,cp3y:60,throat_x:90,throat_radius:15,switcher_x:120,switcher_y:35,exit_x:200,exit_radius:30},scaleY:2,rows:100,cols:200,cellWidth:5,cellHeight:5,canvasHeight:500,visualizationMode:i,velocityX:[],velocityY:[],pressure:[],temperature:[],density:[],isInside:[],isBoundary:[]}),b=E.useCallback(()=>{const M=t.current?.parentElement;if(M){const z=M.clientWidth-120,N=800,T=400;let _=Math.min(z,N),P=_/N*T;_<600&&(_=600,P=300),w({width:_,height:P})}},[]);E.useEffect(()=>(b(),window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)),[b]),E.useEffect(()=>{if(t.current){const M=window.devicePixelRatio||1;t.current.width=h.width*M,t.current.height=h.height*M,t.current.style.width=`${h.width}px`,t.current.style.height=`${h.height}px`;const z=t.current.getContext("2d");z&&z.scale(M,M)}},[h]),E.useEffect(()=>{S&&I.current&&(I.current.visualizationMode=i)},[i,S]);const C=E.useCallback(()=>{y.current?.start&&(y.current.start(),a(!0),l("Running"))},[]),R=E.useCallback(()=>{y.current?.pause&&(y.current.pause(),a(!1),l("Paused"))},[]),D=E.useCallback(()=>{y.current?.reset&&(y.current.reset(),a(!1),l("Reset"),p({min:0,avg:0,max:0}),v({timeStep:0,totalIterations:0,velocityResidual:"-",pressureResidual:"-",massResidual:"-"}))},[]),U=E.useCallback((M,z)=>{y.current?.setTolerance&&y.current.setTolerance(M,parseFloat(z))},[]);E.useEffect(()=>{let M;const z=()=>{if(console.log("Initializing FEA simulation..."),console.log("Canvas ref:",t.current),console.log("Simulation data:",I.current),!t.current){console.log("Canvas not ready yet, retrying"),M=setTimeout(z,100);return}try{console.log("Canvas is ready, initializing FEA..."),ot(t.current,document.getElementById("colorbar"),e.current),I.current.canvasHeight=h.height,y.current=pt(t.current,I),y.current?(y.current.setCallbacks({onStatusUpdate:l,onStatsUpdate:p,onConvergenceUpdate:v}),gt(y.current),f(!0),l("Ready"),console.log("FEA initialization successful")):(console.error("Failed to get simulation control interface"),l("Error"))}catch(T){console.error("Error initializing FEA:",T),l("Error")}};return M=setTimeout(z,200),setTimeout(()=>{if(e.current)try{Ie(e.current)}catch(T){console.error("Failed to draw initial convergence chart",T)}},300),()=>{M&&clearTimeout(M),y.current?.cleanup&&y.current.cleanup()}},[h]);const B=E.useCallback(M=>{c(M.target.value)},[]);return d.jsxs(d.Fragment,{children:[d.jsx($e,{}),d.jsx("div",{className:"title",children:d.jsx("h1",{children:"FEA Nozzle Simulator"})}),d.jsxs("div",{className:"main-layout",children:[d.jsxs("div",{className:"left-section",children:[d.jsxs("div",{className:"canvas-area",children:[d.jsx("canvas",{ref:t,id:"fea-canvas",width:"1000",height:"500",style:{width:`${h.width}px`,height:`${h.height}px`}}),d.jsxs("div",{className:"colorbar-container",children:[d.jsx("div",{id:"colorbar-title",className:"colorbar-labels",children:i.charAt(0).toUpperCase()+i.slice(1)}),d.jsx("div",{id:"max-label",className:"colorbar-labels",children:m.max.toFixed(3)}),d.jsx("canvas",{ref:s,id:"colorbar",width:"30",height:"300"}),d.jsx("div",{id:"mid-label",className:"colorbar-labels",style:{position:"absolute",marginTop:"150px"},children:m.avg.toFixed(3)}),d.jsx("div",{id:"min-label",className:"colorbar-labels",children:m.min.toFixed(3)})]})]}),d.jsxs("div",{className:"controls",children:[d.jsx("strong",{children:"Visualization Mode:"}),d.jsxs("label",{children:[d.jsx("input",{type:"radio",name:"vizMode",value:"pressure",checked:i==="pressure",onChange:B}),"Pressure"]}),d.jsxs("label",{children:[d.jsx("input",{type:"radio",name:"vizMode",value:"velocity",checked:i==="velocity",onChange:B}),"Velocity"]}),d.jsxs("label",{children:[d.jsx("input",{type:"radio",name:"vizMode",value:"temperature",checked:i==="temperature",onChange:B}),"Temperature"]}),d.jsxs("label",{children:[d.jsx("input",{type:"radio",name:"vizMode",value:"density",checked:i==="density",onChange:B}),"Density"]})]}),d.jsxs("div",{className:"stats",children:[d.jsxs("div",{className:"stat-item",children:["Min: ",d.jsx("span",{id:"min-value",className:"stat-value",children:m.min.toFixed(2)})]}),d.jsxs("div",{className:"stat-item",children:["Avg: ",d.jsx("span",{id:"avg-value",className:"stat-value",children:m.avg.toFixed(2)})]}),d.jsxs("div",{className:"stat-item",children:["Max: ",d.jsx("span",{id:"max-value",className:"stat-value",children:m.max.toFixed(2)})]})]})]}),d.jsxs("div",{className:"right-section",children:[d.jsxs("div",{className:"convergence-info",children:[d.jsx("h3",{children:"Simulation Status"}),d.jsxs("div",{className:"convergence-metric",children:[d.jsxs("span",{children:[d.jsx("span",{className:`status-indicator ${A(r)}`,id:"status-indicator"}),"Status:"]}),d.jsx("span",{className:"convergence-value",id:"simulation-status",children:r})]}),d.jsxs("div",{className:"convergence-metric",children:[d.jsx("span",{children:"Time Step:"}),d.jsx("span",{className:"convergence-value",id:"time-step",children:g.timeStep})]}),d.jsxs("div",{className:"convergence-metric",children:[d.jsx("span",{children:"Iterations:"}),d.jsx("span",{className:"convergence-value",id:"total-iterations",children:g.totalIterations})]}),d.jsxs("div",{className:"convergence-metric",children:[d.jsx("span",{children:"Velocity Residual:"}),d.jsx("span",{className:"convergence-value",id:"velocity-residual",children:g.velocityResidual})]}),d.jsxs("div",{className:"convergence-metric",children:[d.jsx("span",{children:"Pressure Residual:"}),d.jsx("span",{className:"convergence-value",id:"pressure-residual",children:g.pressureResidual})]}),d.jsxs("div",{className:"convergence-metric",children:[d.jsx("span",{children:"Mass Residual:"}),d.jsx("span",{className:"convergence-value",id:"mass-residual",children:g.massResidual})]})]}),d.jsxs("div",{className:"convergence-controls",children:[d.jsx("h3",{children:"Controls"}),d.jsxs("div",{style:{textAlign:"center",marginBottom:"15px"},children:[d.jsx("button",{className:"control-button",id:"start-btn",onClick:C,disabled:u,children:"Start"}),d.jsx("button",{className:"control-button",id:"pause-btn",onClick:R,disabled:!u,children:"Pause"}),d.jsx("button",{className:"control-button",id:"reset-btn",onClick:D,children:"Reset"})]}),d.jsx("hr",{}),d.jsxs("div",{style:{margin:"10px 0"},children:[d.jsx("label",{htmlFor:"vel-tolerance",children:"Velocity Tolerance:"}),d.jsx("input",{type:"number",className:"tolerance-input",id:"vel-tolerance",defaultValue:"1e-6",step:"1e-7",placeholder:"1e-6",onChange:M=>U("velocity",M.target.value)})]}),d.jsxs("div",{style:{margin:"10px 0"},children:[d.jsx("label",{htmlFor:"press-tolerance",children:"Pressure Tolerance:"}),d.jsx("input",{type:"number",className:"tolerance-input",id:"press-tolerance",defaultValue:"1e-6",step:"1e-7",placeholder:"1e-6",onChange:M=>U("pressure",M.target.value)})]}),d.jsxs("div",{style:{margin:"10px 0"},children:[d.jsx("label",{htmlFor:"mass-tolerance",children:"Mass Tolerance:"}),d.jsx("input",{type:"number",className:"tolerance-input",id:"mass-tolerance",defaultValue:"1e-6",step:"1e-7",placeholder:"1e-6",onChange:M=>U("mass",M.target.value)})]})]}),d.jsxs("div",{className:"convergence-canvas",children:[d.jsx("h3",{children:"Convergence History"}),d.jsx("canvas",{ref:e,id:"convergence-canvas",width:"400",height:"250"})]})]})]})]})}export{kt as default};
//# sourceMappingURL=FEA-C8VGrj4_.js.map
